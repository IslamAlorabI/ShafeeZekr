name: Build & Release APK

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build & Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Extract version info
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | head -1 | sed 's/.*"\(.*\)".*/\1/')
          VERSION_CODE=$(grep 'versionCode' app/build.gradle.kts | head -1 | sed 's/[^0-9]*//g')
          echo "name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          NOTES=$(awk '/^## v'"${{ steps.version.outputs.name }}"'/{found=1; next} found && /^## v/{exit} found{print}' CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="Release v${{ steps.version.outputs.name }}"
          fi
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > ${{ github.workspace }}/release-key.jks

      - name: Build release APK
        env:
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEYSTORE_PATH: ${{ github.workspace }}/release-key.jks
        run: chmod +x gradlew && ./gradlew assembleRelease --no-daemon

      - name: Rename APK
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          cp "$APK_PATH" "ShafeeZekr-v${{ steps.version.outputs.name }}-build${{ steps.version.outputs.code }}.apk"

      - name: Create verified tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'v${{ steps.version.outputs.name }}';
            const sha = context.sha;
            try {
              await github.rest.git.getRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `tags/${tag}` });
              await github.rest.git.deleteRef({ owner: context.repo.owner, repo: context.repo.repo, ref: `tags/${tag}` });
            } catch (e) {}
            const tagObject = await github.rest.git.createTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag,
              message: `Release ${tag}`,
              object: sha,
              type: 'commit'
            });
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: tagObject.data.sha
            });

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.name }}
          name: v${{ steps.version.outputs.name }} STABLE BUILD [A12+]
          body: ${{ steps.notes.outputs.body }}
          files: ShafeeZekr-v${{ steps.version.outputs.name }}-build${{ steps.version.outputs.code }}.apk
          draft: false
          prerelease: false
          make_latest: true
